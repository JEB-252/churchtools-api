<!DOCTYPE html>
<html>
<head>
    <title>Appointments</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <!-- Include jQuery UI CSS from a CDN -->
    <link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <!-- Include jQuery from a CDN -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- Include jQuery UI from a CDN -->
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <!-- Initialize the datepicker -->
    <script>
        $(function() {
            $("#start_date").datepicker({
                dateFormat: "yy-mm-dd" // This format should match the value you're passing from Flask
            });
            $("#end_date").datepicker({
                dateFormat: "yy-mm-dd"
            });
        });
    </script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css">
    <script>
        function monitorDownload(cookieName) {
            var checkCookie = setInterval(function() {
                if (document.cookie.split(';').some((item) => item.trim().startsWith(cookieName + '='))) {
                    clearInterval(checkCookie);
                    document.cookie = cookieName + '=; Max-Age=-99999999;';  // delete the cookie
                    $('#spinner-overlay').hide();  // hide the spinner
                }
            }, 100); // check every 100ms
        }

        $(document).ready(function(){
            $('input[name="generate_jpeg"]').click(function(){
                // Show the spinner
                $('#spinner-overlay').show();
                // Start monitoring for the jpegGenerated cookie
                monitorDownload('jpegGenerated');
            });

            $('input[name="generate_pdf"]').click(function(){
                // Show the spinner
                $('#spinner-overlay').show();
                // Start monitoring for the pdfGenerated cookie
                monitorDownload('pdfGenerated');
            });
            $('input[name="fetch_appointments"]').click(function(){
                // Show the spinner
                $('#spinner-overlay').show();
                // Start monitoring for the pdfGenerated cookie
                monitorDownload('fetchAppointments');
            });
        });
    </script>
</head>
<body>
<!-- Spinner Overlay -->
<div id="spinner-overlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(255,255,255,0.9); z-index:1000;">
    <div class="spinner" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);">
        <i class="fas fa-spinner fa-spin" style="font-size:3rem; color: #09f;"></i>
    </div>
</div>

<div class="container">
    <a href="/" class="btn btn-back">Zurück</a>
    <h1>Termine nächste Woche</h1>

    <!-- Form to fetch appointments -->
    <form method="POST">
        <!-- Calendars selection -->
        <div class="calendars-container">
            {% for calendar in calendars %}
                <div class="calendar-item">
                    <input type="checkbox" id="calendar-{{ calendar['id'] }}"
                           name="calendar_ids" value="{{ calendar['id'] }}"
                           class="calendar-checkbox"
                            {% if calendar['id']|string in selected_calendar_ids %} checked {% endif %}>
                    <label for="calendar-{{ calendar['id'] }}" class="calendar-label">
                        {{ calendar['name'] }}
                    </label>
                </div>
            {% endfor %}
        </div>

        <!-- Date selection -->
        <label for="start_date">Startdatum:</label>
        <input type="text" id="start_date" name="start_date"
               value="{{ start_date }}" required>

        <label for="end_date">Enddatum:</label>
        <input type="text" id="end_date" name="end_date"
               value="{{ end_date }}" required>

        <!-- Submit button for fetching appointments -->
        <input type="submit" name="fetch_appointments"
               value="Termine abholen" class="btn btn-fetch">
    </form>
    {% if appointments %}
    <form method="POST" enctype="multipart/form-data">
        <div class="appointments-container">
            {% for appointment in appointments %}
                <div class="appointment-item">
                    <input type="checkbox" id="appointment-{{ appointment['id'] }}" name="appointment_id" value="{{ appointment['id'] }}" class="appointment-checkbox" checked>
                    <label for="appointment-{{ appointment['id'] }}" class="appointment-label">{{ appointment['startDateView'] }} ({{ appointment['startTimeView'] }}-{{ appointment['endTimeView'] }}) <br/>{{ appointment['description'] }}</label>
                </div>
            {% endfor %}
        </div>

        <!-- Input for file upload -->
        <label for="background_image">Hintergrundbild:</label>
        <input type="file" id="background_image" name="background_image" accept="image/*">

        <div>
            <label for="date_color">Datum:</label>
            <input type="color" id="date_color" name="date_color" value="#C1540C">
        </div>

        <div>
            <label for="background_color">Transparenter Hintergrund:</label>
            <input type="color" id="background_color" name="background_color" value="#FFFFFF">
        </div>

        <div>
            <label for="description_color">Beschreibung:</label>
            <input type="color" id="description_color" name="description_color" value="#4E4E4E">
        </div>

        <div style="display: flex; gap: 10px;">
            <input type="submit" name="generate_pdf" value="PDF Generieren" class="btn btn-generate" style="display: inline-block;">
            <input type="submit" name="generate_jpeg" value="JPEG generieren" class="btn btn-generate" style="display: inline-block;">
        </div>
    </form>
    {% else %}
        <p>...</p>
    {% endif %}
</div>
</body>
</html>
